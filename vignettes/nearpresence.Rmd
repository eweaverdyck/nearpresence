---
title: "Near Presence Analysis"
author: "Eli Weaverdyck"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Near Presence Analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```
```{r setup}
library(nearpresence)
```

# Introduction
The nearpresence package was built to conduct Near Presence Cluster Analysis (NPCA), a statistical technique for identifying spatial clustering in binary presence / absence data observed in irregularly distributed polygonal units that may or may not be contiguous.  

It was designed in the context of an archaeological surface survey, where rectangular observation units (‘tracts’) are distributed across a landscape, and data is recorded at the level of those tracts. Tracts rarely cover a landscape entirely. Rather, they are distributed according to a sampling strategy (see Banning 2002 for an overview of sampling strategies) that often produces an irregular distribution of observations consisting of both contiguous and non-contiguous sets of tracts. This makes it difficult to deploy common spatial-statistical techniques, which are usually designed for situations in which the observation units are contiguous and completely cover the area of investigation, e.g., census tracts or urban neighborhoods.  

NPCA addresses similar questions as Local Indicators of Spatial Association (LISA) in the sense of Anselin 1995. However, in contrast to most LISAs, the property measured is not the similarity between a certain unit of observation and its neighbors, but the relative proportions of presence and absence in a unit’s neighbors weighted by the distances to those neighbors. The presence / absence categorization of the unit itself enters at a later stage in the interpretive process. This is useful for an iterative investigation strategy because it highlights units that are near clusters, and therefore may repay further investigation, even if they do not contain the material under investigation.  

This is useful in archaeological surface survey for three reasons. First, tracts neighboring clusters might be targeted for resurvey to see if the initial observation missed relevant material. Second, not all artifacts are equally easy to identify, and the time of various pottery specialists is a scarce resource. Survey leaders with a general knowledge of pottery forms might be able to identify, for example, Late Roman amphorae based on a distinctive combing pattern, but it takes more knowledge to date a small fragment of red-slipped fine ware. NPCA will identify not only the clusters of tracts with Late Roman material present, but also the neighbors of those tracts. Experts can then be asked to examine material from those tracts to see if the Late Roman cluster extends further than initially thought. Third, spatial associations between different types of material can be very informative. To continue our example, the presence of slag in a tract next to a cluster of tracts containing Late Roman material might provide evidence for iron smelting on the edge of a settlement. NPCA draws the researcher’s attention not only to clusters of tracts with a certain type of material present, but to neighboring tracts as well, making it more likely that these types of associations will be noticed.  

# Near Presence Cluster Analysis and its implementation in the nearpresence package
Near Presence Cluster Analysis requires several analytical steps:  

1. First, one converts spatial data into a numeric spatial model that defines each tract’s neighbors and the spatial relationship between the tract and each neighbor. 
2. Next, one calculates a Near Presence (NP) score for each tract. 
3. Then one determines the significance (high or low) of those scores. 
4. Finally, this information is combined with the presence / absence categorization of the tract. The first step can be achieved using the functions `IDW_nnear` and `IDW_radius`. The following steps are all implemented within the function `NP`.  

The package contains a small set of example data generated by the Molyvoti, Thrace, Archaeology Project's 2015 survey. These data consist of:   

* `tracts`, an `sf` object containing the geometry of 148 tracts surveyed with an attribute table containing a unique identifier
* `chron`, a table containing, for each tract in `tracts`, a unique identifier and chronological presence / absence data for 15 different chronological periods.

## The spatial model
`IDW_nnear` and `IDW_radius` provide two different methods of defining neighbors. `IDW_nnear` defines the `n` nearest tracts as neighbors, while `IDW_radius` defines all tracts within a radius `r` as neighbors.  

Both rely on `sf::st_distance`, as this measures distances between the edges of polygons rather than centroids. The output of `sf::st_distance` is a large matrix containing the distances between every tract and every other tract. An `ifelse` function is applied to every row in this matrix, which identifies the tract's neighbors, calculates the inverse of these distances plus 1, and sets all other values to `NA`.   

For efficiency, the resulting matrix is converted to a named list of named lists. Each element of the list corresponds to one tract, named using its unique identifier. These elements are themselves lists of weights of each tract's neighbors, again named using the neighbors' unique identifiers. I refer to this list of lists as a spatial weights list, `swl`.

```{r, message = FALSE}
data(tracts)
swl_nnear<-IDW_nnear(tracts, "UnitID", 8)
swl_radius<-IDW_radius(tracts, "UnitID", 500)
```


## Calculating the Near Presence (NP) score
The NP score is calculated for each tract individually. It is the weighted average of the tract’s neighbors’ presence and absence scores, coded as 1 and 0. The NP score of tract *i* is expressed as:
$$NP_i = \frac{1}{n} \sum_{i}^{n} w_j x_j$$
where *n* is the is the number of neighbors *x*. Weights (*w*) are the inverse of the distances to each neighbor plus 1, to avoid dividing by 0:
$$w_j = \frac{1}{d_{ij} + 1}$$

## Determining significance
The value of the NP score depends not only on the presences and absences of neighboring tracts, but the spatial relationships between the tract and its neighbors. When tracts are irregularly distributed, these relationships can be very idiosyncratic, so it is inappropriate to compare NP scores to each other. To determine whether a NP score should be seen as high or low, it must be compared to a distribution of NP scores that would be observed for that tract if the presences and absences were randomly distributed across the entire study area, i.e., a permutation test. `sample`, with `size` equal to the number of tracts, is used to generate a comparison distribution with the observed number of presences and absences.

The user then defines a cutoff value (e.g., 0.01, 0.05, or 0.10) to define which scores are significantly high or low and which are moderate. The NP score ranges from 0 to 1, and when presences are scarce relative to absences, most NP scores in the comparison distributions will be 0. Therefore, statistically significant low NP scores can only be observed when presences are relatively common. Given the ubiquity of ties, high and low significance must be calculated separately. High scores are those in which the majority of permutation-derived NP scores are lower than the observed NP score, and low scores are those in which the majority of permutation-derived NP scores are higher than the observed NP score.  

## Combining NP scores with presence / absence values of tracts
the `NP` function combines the significance designations of NP scores with presence / absence values in two ways.

The simplest is a combination into a categorical variable with six levels:

* Present, High NP
* Present, Moderate NP (indistinguishable from permutation-based NP scores)
* Present, Low NP
* Absent, High NP
* Absent, Moderate NP (indistinguishable from permutation-based NP scores)
* Absent, Low NP

Slightly more complicated is a determination of cluster membership. Tracts that are designated as cluster members fulfill one of two conditions:

1. They have material present and have a high NP score, OR
2. They have material present and are the neighbor of a tract with material present and a high NP score.

# Visualizing and interpreting the results
These results can then be visualized either within R or any other GIS software for further interpretation. When visualizing the combination variable, it is recommended that the user choose colors that emphasize tracts with significant NP scores and de-emphasize those that do not.  The `NP_colors` function applies such a color scheme to the combination variable.

Visualizing cluster membership produces very simple, striking maps that are easy to interpret, but note that a great deal of information is lost. In particular, there may be tracts with material present that are neighbors of tracts that fulfill condition 2, but not condition 1. These tracts are not identified as cluster members by the `NP` function, so the user may wish to overlay Presence / Absence data on top of the cluster membership visualization.  

The following code shows an example of the use of NPCA to analyze the distribution of Classical period material using the spatial models generated above. These define neighbors as the eight nearest tracts (`swl_nnear`) and all tracts within 500 m (`swl_radius`). The first plot shows the raw presence / absence of this material in the example data (`Clas`). The following plots show the results of NPCA, displaying the combined results variable `Clas_Res` and the cluster membership variable `Clas_mem`.

Note that, for reasons of efficiency, only 100 permutations are used to generate the comparison datasets. Robust results will require more permutations.  

```{r, fig.width=7, fig.height = 5, message = FALSE}
data(chron)
np_near<-NP(chron, "Survey_Uni", "Clas", tracts, "UnitID", swl_nnear, 100, 0.1)
plot(np_near["Clas"])

par(xpd = TRUE)
plot(np_near["Clas_Res"], col=NP_colors(np_near[["Clas_Res"]]))
legend("topleft", 
       inset = c(-0.1, -0.1), 
       legend = c("Present, High NP", "Present, Low NP", "Present, Moderate NP",
                  "Absent, High NP", "Absent, Low NP", "Absent, Moderate NP"),
       fill = c("#e60000", "#feff73", "#ffaa01","#febebe", "#ddd2ff", "#b5d69f"))
plot(np_near["Clas_mem"])

np_radius<-NP(chron, "Survey_Uni", "Clas", tracts, "UnitID", swl_radius, 100, 0.1)

par(xpd = TRUE)
plot(np_radius["Clas_Res"], col=NP_colors(np_radius[["Clas_Res"]]))
legend("topleft", 
       inset = c(-0.1, -0.1), 
       legend = c("Present, High NP", "Present, Low NP", "Present, Moderate NP",
                  "Absent, High NP", "Absent, Low NP", "Absent, Moderate NP"), 
       fill = c("#e60000", "#feff73", "#ffaa01","#febebe", "#ddd2ff", "#b5d69f"))
plot(np_radius["Clas_mem"])
```

Although Classical-period material is distributed throughout the study area, NPCA allows us to identify four major clusters. The precise extent of these clusters depends on the spatial model used. Nevertheless, these results can inform further investigation. The tracts designated Absent, High NP can be reexamined, and the functional range of artifacts found in the tracts identified as cluster members (and possibly their neighbors) can provide evidence about the types of activities that generated these clusters.
